# Willow64 ビルドガイド


#### TOC
- [はじめに](#はじめに)
- [組み立て前の準備](#組み立て前の準備)
- [組み立て手順](#組み立て手順)
- [トラブル時の対処](#トラブル時の対処)
- [参考情報](#参考情報)

## はじめに

本ドキュメントはWillow64を組み立てるための手順について記しています。

組み立てを始める前に本書をよくお読みいただき全体をご理解してから作業に着手することをお勧めします。

なお本ドキュメントは次のモデルを想定した説明を記しています。
    
    Willow64 Assemly kit (PCB Rev.2  model SPA-S1)
#### 想定するユーザスキル
- パソコン操作 (必須)

  - 本キーボードの組み立て及び利用にはWindows PC もしくは MACが必要です。
  - このキットの作者はWindows10を利用しているため、ビルドガイドもその環境を想定した記述となっていますが、MACについてもほとんど同じですので各自で読み替えてください。

- はんだ付け (必須だけど初めてでもOK)

  - 本組み立てキットは、はんだ付けの工程が必要です。

  - 表面実装タイプの部品を取り扱う箇所があるため 組み立て難易度としてはやや高い部類になります。
  - はんだ付けの経験があることに越したことはありませんが、初めてでも前向きなやる気があれば問題ありません。
  - はんだ付けについての様々な情報やテクニックについては本書末尾にまとめていますので、必要に応じて参照してください。
  
- 黒い画面の操作 (あると良い)

  - キーボードの頭脳となるマイクロコンピュータへファームウェアを書き込む作業があります。
  - 本ドキュメントではなるべく簡易な方法について説明をしますが、本格的に本キーボードの機能を利用するには、”黒い画面”(コンソールからのCUI操作) と向き合う必要がでてきます。
  - こちらについてもネット上に様々な優れた情報が存在するので、本書末尾にまとめますので必要に応じて参照してください。

- トラブル解決力 (なるべく必要)

  - こういった繊細なガジェットを手作りするときは様々なトラブルにぶち当たる可能性が多々あります。
  - 本書でもなるべくトラブルシュートが可能な情報を載せるようにしていますが全てを網羅することはできません。
  - トラブルに行き当たった際、そのときは自分自身で解決まで持っていく必要があるということを念頭に置いて取り組むようにしてください。 
  - 作者やコミュニティーに質問を投げかける前に、ネットなどで過去事例を調べることは最低限必要ですし大抵のことは先達たちの経験やノウハウで解決できるはずです。

#### このドキュメントでは言及しない内容

- キーボードの動作原理
- はんだ付けの基本的なテクニック
- QMK Firmwareの概要、導入、ビルド、カスタマイズ方法
- GIT、GitHubの使い方

## 1.組み立て前の準備
組み立てを始める前に、本章の内容を確認し準備が十分に整っていることを確認してから次に進んでください。
### 組み立てキット内容物
パッケージを開けたら、まず内容物が正しく揃っているかを確認します。


- PCB (プリント基板)  (右手 1個、左手 1個)

  電子部品を取り付けるプレートです。 左右で形状が異なります。写真を参考に左右と表裏を判別してください。


- マウントプレート (右手 1個、左手 1個)
  
  キースイッチを取り付けるためのプレートです。左右で形状が異なります。

- ボトムプレート (右手 1個、左手 1個)
  
  キーボードの下面となるプレートです。左右で形状が異なります。

- アンダーカバー (右手 1個、左手 1個)
  
  ボトムプレートの開口している部分を覆うためのプレートです。左右で形状が異なります。


- スイッチソケット (128個)

  キースイッチをはんだ付けなしで取り付け、後から付け替え可能にするためのパーツです。

- ダイオード(SMD) (128個 +予備少々)
  
  電気信号を制御するためのパーツです。非常に小さいので紛失しないよう気をつけてください。

- タクトスイッチ  (2個)

  リセットスイッチとして使用するためのパーツです。

- TRRSジャック  (2個)

  分割された2つのキーボードを接続し一体として利用するためのケーブルを挿し込むパーツです。

- ネジ
  
  ネジは長さの異なる3種類あります。
  - ネジ(M2 L3)  (32個)
  - ネジ(M2 L5)  (8個)
  - ネジ(M2 L9) (6個)

- スペーサー
  
  スペーサーは長さの異なる2種類あります。
  - スペーサ(3.5mm)  (8個)
  - スペーサ(8.0mm)  (6個)
  
- ゴム足 (8個)
  
  キーボードの裏側に取り付けます

### 組み立てキット以外に必要な部品
本組み立てキットに含まれる部品以外に、ユーザ自身で揃える必要がある部品があります。

組み立てを始める前に揃っていることを確認します。

なるべく日本の自作キーボード界隈でよく使われている部品を選定しているので
本書末尾のショップ一覧から入手可能です。

#### 必ず必要な部品
- ProMicro (2個)
  
  キーボードの頭脳として、左右一つづつ 合計2つ準備します。

- スプリングピンヘッダ (4個)

  ProMicroをPCBに装着する際に取り外し可能とするパーツです。ProMicro 1つに対し2個、合計4個準備します。

  スプリングピンヘッダがない場合は、通常のピンヘッダをPCb側にはんだ付けすることで代用できますがProMicrowo取り外すことはできなくなります。

- Cherry MK互換スイッチ  (64個)

  自作キーボードの醍醐味の部分なのでお好みで準備ください。
  Cherry MK互換 (3ピンもしくは5ピンタイプ)に対応しています。
  Kailhロープロファイルスイッチには非対応です。


- キーキャップ 

  お好みに応じて準備してください。ANSI USタイプが適合します。

  注記) 
    - Willow64 PCB (Rev.2)では、キーボード右上部分のBacksSpaceキーの部分は2Uタイプのキャップに非対応です。
    - その代わりに1Uのキーキャップが2個置ける配置となっていますのでご注意ください。


- TRRSケーブル (もしくはTRSケーブル)  (1本)
 
  左右に別れたキーボードを連結します。

- USB  Micro-Bケーブル (1本)

  パソコンとキーボードを接続するのに利用します。

### 必要に応じて揃える部品

- スタビライザ(2U)  (2個)

  横に長いキーの動作を安定させるために使用します。  無くてもキーボードとしては機能します。
  
  安いスタビライザを使うとカチャカチャとうるさい場合があるのでお好みによって調達してください。

- LED (マイコン内蔵RGB LED SK6812MINI-E) (64個)

  各キーを下側から光らせるために使用します。  無くてもキーボードとしては機能します。
  
  LEDを実装すると  キーボードを光で演出する、レイヤ動作モードを光で知らせる、CAPSLOCKやNUMLOCK状態を表示する、といったことが可能となります。

  部品の入手や実装は少し大変ですが、所有する満足度も上がるのお勧めします。

- エポキシ接着剤

  ProMicroのUSBコネクタは強度が弱くすぐ断線してしまうことが多いので、周辺を補強するために使用します。
  100円ショプなどで2液タイプのものが手に入ります。

  (ProMicroにUSBケーブルを接続する際にに注意や対処を怠ると、最初の動作確認中の段階でも断線してしまうう場合がありますので Strongly recommend) 

### 組み立てに必要なツール
電子工作の基本的なツールを用意します。

#### 必要なツール
- はんだごて

- はんだ

- ピンセット / 逆作用ピンセット

  非常に小さな部品をはんだ付けする際の保持等に使用します。

- 精密ドライバ(M2サイズ)
  
  ケースを組み立てる際にネジ止めを行います。

- テスタ(マルチメータ)

  キーボードがうまく動作しない場合に原因を探るため使用します。

#### お好みに応じて用意するツール 
- はんだ付けの周辺グッズ
  
  コテ台、スポンジ、作業マット、吸煙ファン、等

- ハンダ吸い取り線

  はんだ付けは失敗しない、という方は不要です

- フラックス

  表面実装部品を扱うため推奨です。

- フラックス洗浄剤

  はんだ付けしたあとの茶色い汚れを取り除くため使用します。白いPCBの場合は茶色い汚れが目立ちますし、中長期的な品質維持のためにもはんだ付け後にフラックス洗浄することをお勧めします。

- ラジオペンチ

  スペーサをネジで固定するときの保持等に。

- マスキングテープ

  はんだ付けする際のパーツの固定等に。アクリルプレートの保護シートを剥がすときにも便利です。
 
 ### ファームウェア書き込み環境の準備

キーボードの頭脳となるProMicroにファームウェアをPCから書き込むための環境を予め準備します。
##### QMK Toolboxのダウンロードとインストール
 - QMK Toolboxは、ファームウェアをマイコン(ProMicro)へ書き込むために必要となります。
 (既に環境がある方は不要です)

 - 下記から QMK Toolboxをダウンローして自身のPCへインストールします。

    https://qmk.fm/ja/toolbox/

 - インストール方法はサイトの情報に従ってください。必要に応じてドライバもインストールします。

#### Willow64用のファームウェアをダウンロード
 - Willow64のビルド済みファームウェアを下記のURLからダウンロドしPCへ保存しておきます。

    - 動作確認用 
    - 標準キーマップ
## 組み立て手順

- [1.ProMicroのUSBコネクタ周辺の補強(オプション)](#1.ProMicroのUSBコネクタ周辺の補強(オプション))
- [2.ProMicroの取り付け](#2.ProMicroの取り付け)
- [3.TRRSジャックの取り付け](#3.TRRSジャックの取り付け)
- [4.リセットスイッチの取り付け](#4.リセットスイッチの取り付け)
- [5.動作確認用ファームウェアの書き込み](#5.動作確認用ファームウェアの書き込み)
- [6.LEDのはんだ付け(オプション)](#6.LEDのはんだ付け(オプション))
- [7.ダイオードのはんだ付け](#7.ダイオードのはんだ付け)
- [8.スイッチソケットのはんだ付け](#8.スイッチソケットのはんだ付け)
- [9.キーの動作確認](#9.キーの動作確認)
- [10.スタビライザーの取り付け(Option)](#10.スタビライザーの取り付け(Option))
- [11.ケースの組み立て](#11.ケースの組み立て)
- [12.キースイッチの取り付け](#12.キースイッチの取り付け)
- [13.キーキャップの取り付け](#13.キーキャップの取り付け)
- [14.本稼働用のファームウェアの書き込み](#14.本稼働用のファームウェアの書き込み)


NOTE
 - パーツは、全てPCBの裏面に配置します。PCBの表面にはパーツが配置されることはありません。
 - はんだ付けはパーツの種類ごとに、PCB裏面から行うか表面から行うか分かれるので手順に従ってください。

### 1.ProMicroのUSBコネクタ周辺の補強(オプション)
下記作業を、2つのProMicroに対して行います。

- ProMicroのUSBコネクタ部分をエポキシ樹脂で強化します。
- エポキシ樹脂説明書の指示通りに調合し、爪楊枝の先などで慎重にUSBコネクタ周辺に盛り付けます。
- 樹脂が硬化するまで安静にします。

NOTE
- USB端子の中やスルーホールに液がに侵入しないよう十分に気をつけます。

### 2.ProMicroの取り付け
下記作業を、2つのProMicroに対して行います。

- PCBの裏側を上向きにします
- スプリングピンヘッダの足の長い方をPCBの裏側からスルーホールへ差し込みます。
- ProMicroの部品が実装してある面(こちらを表側と呼びます)が内側に隠れるような向きでピンヘッダに差し込みます
- ProMicroの裏側裏側(平らな面)側から、全てのピンをはんだ付けします。
  

NOTE 
  - PCB側のピンヘッダははんだ付けしません。はんだ付けするのはProMicro側だけです。
  - ProMicroの表裏を間違えるとリカバリが非常に大変ですのではんだ付けの前に向きに注意ください。
  - ProMicroはPCBの裏側から差し込みます。PCBの表裏に注意ください。

### 3.TRRSジャックの取り付け
下記作業を、左右のPCBに対して行います。

- TRRSジャックをPCBの裏側からシルクに合わせて取り付けます。
- PCBの表側からはんだ付けします。

### 4.リセットスイッチの取り付け
下記作業を、左右のPCBに対して行います。

 - タクトスイッチをPCBの裏側からシルクに合わせて取り付けます。
 - PCBの表側からはんだ付けします。

NOTE
 - タクトスイッチは向きの指定はありません。

### 5.動作確認用ファームウェアの書き込み

LEDおよびキースイッチの動作確認用のファームウェアをProMicroに書き込みます。

- PC上で QMK Tookboxを起動します
- Openボタンをクリックし、入手した動作確認用firmwareファイルを指定します。
- Auto-Flashの部分をチェックします

下記作業を2つのProMicroに対して行います。
- USBケーブルでPCとProMicroを接続します。
- PCB上のリセットスイッチ押します。
- QMK Toolbox上で書き込みログが表示されるので正常に完了することを確認します

### 6.LEDのはんだ付け(オプション)

LEDをPCBにはんだ付けします。

下記作業を2枚のPCB 合計64箇所に対して行います。

- PCBの裏側から四角い穴に合わせてLEDをはめ込みます。
  - この時、LEDの発光面がPCBの表側に来る向きにします。
  - PCBにプリントされた三角のとLEDの足が短い端子が合うように方向を合わせます。
- PCBのランドとLEDの足 4箇所をはんだ付けします。 
- USBケーブルでPCとProMicroを接続し、はんだ付けしたLEDが発光することを確認します。

NOTE
  - LEDをはんだ付けする際はフラックスを塗布するとハンダが乗りやすいです。
  - LEDの裏表、LEDの向きを間違うとLEDは発光しません。
  - LEDは高温に弱く長時間はんだごてを押し当てると破損するため、なるべく手早くはんだ付けするよう注意します。
  - LEDはチェーンのように連鎖した接続されています。途中で不良があると、それ以降のLEDは全て動作しないので注意ください。
  - LEDは次のように連鎖していますので参考にして不良箇所を特定します。 
  - はんだ付けを行いている最中はUSBケーブルは接続しません。

### 7.ダイオードのはんだ付け

ダイオードをPCBにはんだ付けします。

下記作業を左右のPCB 合計64箇所に対して行います。

- ダイオードの向きとPCBのシルクを合わせて、ダイオードの両端をはんだ付けします。
  - PCBのランドの片方に予備ハンダを盛ります
  - 予備ハンダを溶かしつつダイオードを所定の位置に送り込みます。
  - 反対側をはんだ付けします
  - 予備ハンダをしたほ方をもう一度はんだ付けします


NOTE 
 - ダイオードには極性があります。
   - ダイオードに薄く線が引かれている方(カソード)と、PCBにシルクで線が引かれている方向を合わせるようにします。
   - ダイオードの向きに間違いがあるとそのキーは反応しなくなるので注意ください。
 - フラックスを塗布すると作業性が向上します(逆に塗布しないと非常に苦労します)。
 - 部品の浮きが無いように注意ください。
 - ダイオードは非常に小さいため紛失しないよう注意ください。
 - ダイオードのはんだ付けのテクニックについては末尾の情報を参考にしてください。
  
### 8.スイッチソケットのはんだ付け

スイッチソケットをPCBにはんだ付けします。

下記作業を左右のPCB 合計64箇所に対して実施します。

- スイッチソケットを差し込みます。PCBのホールに干渉しないよう向きに注意します。
- 2箇所をはんだ付けします。

NOTE
- 部品の浮きがないように注意ください。

はんだ付けの作業はここまでです。 
### 9.キーの動作確認
ケースを組み立てる前に、各キーが正しく反応するか電気的な動作確認を行います。

下記作業を左右2枚のPCBに対して実施します。

- PCのブラウザで次の動作確認用のURLを開きます。
  
   https://config.qmk.fm/#/test

- ProMicroをUSBケーブルでPCと接続します。

- PCBの表側から、ピンセットの先端をスイッチソケットの穴に差し込みます。
  
  ピンセットを用いる代わりに本物のスイッチを差し込んで確認しても構いませんが、
  後述のケース組み立ての前に全て取り外す必要があります。

- ブラウザ上の表示でキーが押された状態になることを確認します。
  
  右手側のキーボードの試験でも左手側相当のキーコードが送られるので慌てないでください。

NOTE
 - 一部のキーが反応しない場合の確認箇所
    - ダイオードの向き間違い
    - ダイオードのはんだ付け不良
    - スイッチソケットのはんだ付け不良

 - 全くどのキーも反応しない場合の確認箇所
    - ProMicroに正しくファームウェアが書き込まれているか 
    - ProMicroのはんだ付け不良
    - ProMicroのピンヘッダが曲がっていないか


### 10.スタビライザーの取り付け(Option)
 スタビライザーを使用する場合は、ケースを組み立てる前のこの段階でPCBへ取り付けます。

### 11.ケースの組み立て

下記作業を左右それぞれのキーボードに対して行います。

- トッププレートに写真を参考に表側からネジ(M2 L3)を差し込み、裏側にスペーサ(3.5mm)をネジ止めします(4箇所)。

- PCBをあわせ、PCB裏側からネジ(M2 L3)で結合します。

- トッププレートに写真を参考に表側からネジ(M2 L3)を差し込み、裏側からスペーサ(8.0mm)をネジ止めします(8箇所)。

- ボトムプレートと更にアンダーカバープレートを合わせ、写真を参考に ネジ止めします。
  ネジ(M2 L5)とネジ(M2 L9)の二種類のネジを適切な箇所に使います。

- ゴム足を4箇所に貼り付けます。


### 12.キースイッチの取り付け

キースイッチを取り付けます。

NOTE
  - まっすぐ上から慎重に差し込むようにします。
  - スイッチのピンは曲がりやすいので注意します。ピンが曲がるとそのキーは反応しなくなります
  - ピンが曲がってしまった場合は、一度引き抜いてラジオペンチの先端で慎重に伸ばせばリカバリ可能です。

### 13.キーキャップの取り付け

- 下図を参考にキースイッチにキーキャップを取り付けます。

- 最後にもう一度、全てのキーが動作するか確認を行います。

以上で組み立ては完成です。

### 14.本稼働用のファームウェアの書き込み

下記の作業を左右のキーボードそれぞれに対して行います。

- PC側で、QMK Toolboxを起動し、本番用ファームウェア(willow64_r2_default.hex)をオープンします。
- QMK Toolboxの Auto_flushをチェックします
- USBケーブルを接続します。
- リセットスイッチを押してファームウェアを書き込みます。


* * *
## トラブル時の対処
ありがちなトラブルとその対処について記します。

- 特定のキーが反応しない
   
  大抵の場合は下記の原因が考えられるので落ち着いて調べます
  - キースイッチのピン(足)が折れ曲がっていないか
  - ダイオードの向きが逆でないか
  - ダイオードのはんだ付け不良はないか
  - キーソケットのはんだ付け不良はないか
  - そもそも、そのキーにキーコードが割り当てられていない(レイヤー切り替え等)

- どのキーも反応しない
    - PCとキーボードが正しくUSBで接続されているか。通電するとProMicro表側に実装されたLEDが点灯します。
    - 左右どちらのProMicroにも正しくファームウェアが書き込まれているか。
    - ProMicroのはんだ付け不良はないか
    - ProMicroのピンヘッダが曲がっていないか

- ダイオードを無くしてしまった
  - 通販でも入手可能です。
     (高速スイッチング・ダイオード　１Ｎ４１４８Ｗ)を購入してください。

- マウントプレートの穴が小さくてキースイッチが入らない、もしくは緩くて抜け落ちる
  - スイッチはメーカやモデルによって微妙にサイズが異なるため、加工精度(公差)を
    考慮して少し小さめにしてあります。
  - 全く入らない場合は穴の方をヤスリで少し削ってください。
  - 逆に抜け落ちるような場合はプレート裏側からグルーガンで固定してください。
    
## 参考情報

### キーボードパーツショップ(日本)

自作キーボードの代表的なショップを列挙します(順不同)。前述のみ立てキット以外に必要な部品は下記ショップでほぼ揃います。

- 遊舎工房 (https://yushakobo.jp/)
- TALP KEYBOARD (https://talpkeyboard.stores.jp/)
- ゆかりキーボードファクトリ (https://eucalyn.shop/)
- 秋月電子通商 (https://akizukidenshi.com/catalog/default.aspx)

### はんだ付け技能
下記以外にも様々なテクニックやノウハウが公開されているので、検索サイトで調べるようにしてください。

- [電子工作のコツ/はんだ付け ](https://article.murata.com/ja-jp/article/soldering)村田製作所
- [ハンダ付け職人のはんだ付け講座](https://godhanda.co.jp/blog/category/handakouza/soldering%E3%80%80guide/)ゴッドはんだ株式会社
- [表面実装部品（SMD）のはんだ付け](https://www.kogadenshi.co.jp/%E5%8D%8A%E7%94%B0%E4%BB%98%E3%81%91%E3%83%86%E3%82%AF%E3%83%8B%E3%83%83%E3%82%AF/%E8%A1%A8%E9%9D%A2%E5%AE%9F%E8%A3%85%E9%83%A8%E5%93%81-smd-%E3%81%AE%E5%8D%8A%E7%94%B0%E4%BB%98%E3%81%91/) 株式会社古賀電子

以上


